version: "3.8"

services:
  kafka:
    image: "confluentinc/cp-kafka:{{ confluent_version }}"
    container_name: "kafka-{{ inventory_hostname_short | default(inventory_hostname) }}"
    hostname: "{{ inventory_hostname }}"
    restart: unless-stopped

    ports:
      - "{{ kafka_broker_port }}:{{ kafka_broker_port }}"
      - "{{ kafka_controller_port }}:{{ kafka_controller_port }}"
{% if jmx_enabled %}
      - "{{ jmx_agent_port_kafka }}:{{ jmx_agent_port_kafka }}"
{% endif %}

    environment:
      ########################################################
      # Contexte Ansible / KRaft
      ########################################################
      {% set is_controller = inventory_hostname in groups.get('kafka_controllers', []) %}
      {% set is_broker = inventory_hostname in groups.get('kafka_brokers', []) %}
      {% set _all = (groups.get('kafka_brokers', []) + groups.get('kafka_controllers', [])) %}
      {% set _fallback_id = _all.index(inventory_hostname) + 1 if inventory_hostname in _all else 1 %}
      {% set _ctrl_hosts = groups.get('kafka_controllers', []) %}
      {% set node_id = hostvars[inventory_hostname].get('node_id', _fallback_id) %}
      {% set kafka_host = hostvars[inventory_hostname].get(
          'kafka_bind_ip',
          hostvars[inventory_hostname].get(
            kafka_listeners_host_var,
            hostvars[inventory_hostname].get('ansible_host', inventory_hostname)
          )
      ) %}
      {% set keystore_filename = kafka_ssl_keystore_location.split('/')[-1] %}
      {% set truststore_filename = kafka_ssl_truststore_location.split('/')[-1] %}

      # Obligatoire pour cp-kafka en KRaft
      CLUSTER_ID: "{{ kafka_cluster_id }}"
      KAFKA_LOG_DIRS: "{{ kafka_data_dirs | join(',') }}"

      ##### Tuning ####################################
     
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "{{ kafka_auto_create_topics | default('true') }}"
      KAFKA_NUM_PARTITIONS: "{{ kafka_num_partitions | default(3) }}"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "{{ kafka_internal_replication_factor | default(3) }}"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "{{ kafka_internal_replication_factor | default(3) }}"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "{{ kafka_internal_min_isr | default(2) }}"

      ######## Controle  #####################################"" 
      KAFKA_PROCESS_ROLES: "{% if is_controller and is_broker %}broker,controller{% elif is_controller %}controller{% else %}broker{% endif %}"
      KAFKA_NODE_ID: "{{ node_id }}"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "{% for h in _ctrl_hosts -%}{{ hostvars[h].get('node_id', loop.index) }}@{{ hostvars[h].get('kafka_bind_ip', hostvars[h].get(kafka_listeners_host_var, hostvars[h].get('ansible_host', h))) }}:{{ kafka_controller_port }}{% if not loop.last %},{% endif %}{%- endfor %}"

      ########################################################
      # MODE NON SÉCURISÉ (PLAINTEXT) : sasl_enabled == false
      ########################################################
{% if not sasl_enabled %}
      # Listeners PLAINTEXT
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:{{ kafka_broker_port }}{% if is_controller %},CONTROLLER://0.0.0.0:{{ kafka_controller_port }}{% endif %}"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://{{ kafka_host }}:{{ kafka_broker_port }}"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT{% if is_controller %},CONTROLLER:PLAINTEXT{% endif %}"

{% else %}
      ########################################################
      # MODE SÉCURISÉ (SASL_SSL + SCRAM + SSL) : sasl_enabled == true
      ########################################################

      ########################################################
      # Listeners
      # - SASL_SSL : clients + inter-broker
      # - CONTROLLER : KRaft (PLAINTEXT interne)
      ########################################################
      KAFKA_LISTENERS: "SASL_SSL://0.0.0.0:{{ kafka_broker_port }}{% if is_controller %},CONTROLLER://0.0.0.0:{{ kafka_controller_port }}{% endif %}"
      KAFKA_ADVERTISED_LISTENERS: "SASL_SSL://{{ kafka_host }}:{{ kafka_broker_port }}"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "SASL_SSL"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "SASL_SSL:SASL_SSL{% if is_controller %},CONTROLLER:PLAINTEXT{% endif %}"

      ########################################################
      # SASL / SCRAM
      ########################################################
      KAFKA_SASL_ENABLED_MECHANISMS: "SCRAM-SHA-256"
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: "SCRAM-SHA-256"

      # JAAS inline pour le listener SASL_SSL
      KAFKA_LISTENER_NAME_SASL_SSL_SCRAM_SHA_256_SASL_JAAS_CONFIG: >
        org.apache.kafka.common.security.scram.ScramLoginModule required
        username="{{ kafka_scram_user }}"
        password="{{ kafka_scram_password }}";

      ########################################################
      # SSL (Keystore / Truststore)
      ########################################################
      KAFKA_SSL_KEYSTORE_FILENAME: "{{ keystore_filename }}"
      KAFKA_SSL_TRUSTSTORE_FILENAME: "{{ truststore_filename }}"

      KAFKA_SSL_KEYSTORE_LOCATION: "/etc/kafka/secrets/{{ keystore_filename }}"
      KAFKA_SSL_TRUSTSTORE_LOCATION: "/etc/kafka/secrets/{{ truststore_filename }}"

      KAFKA_SSL_KEYSTORE_PASSWORD: "{{ kafka_ssl_keystore_password }}"
      KAFKA_SSL_KEY_PASSWORD: "{{ kafka_ssl_key_password | default(kafka_ssl_keystore_password) }}"
      KAFKA_SSL_TRUSTSTORE_PASSWORD: "{{ kafka_ssl_truststore_password }}"

      KAFKA_SSL_KEYSTORE_CREDENTIALS: "keystore.creds"
      KAFKA_SSL_KEY_CREDENTIALS: "key.creds"
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: "truststore.creds"

      KAFKA_SSL_CLIENT_AUTH: "{{ kafka_ssl_client_auth | default('none') }}"
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: "{{ kafka_ssl_endpoint_identification_algorithm | default('') }}"

      ########################################################
      # ACL / Authorizer
      ########################################################
      KAFKA_AUTHORIZER_CLASS_NAME: "org.apache.kafka.metadata.authorizer.StandardAuthorizer"
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: "false"
      # Contrôleur en PLAINTEXT = ANONYMOUS + ton user SCRAM admin
      KAFKA_SUPER_USERS: "User:ANONYMOUS;User:{{ kafka_scram_user }}"

{% endif %}

{% if sasl_enabled %}
      ########################################################
      # KAFKA_OPTS en mode sécurisé (JAAS + éventuellement JMX)
      ########################################################
{%   if jmx_enabled %}
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/secrets/kafka_server_jaas.conf -javaagent:/opt/jmx/jmx_prometheus_javaagent.jar={{ jmx_agent_port_kafka }}:/etc/kafka/kafka_jmx.yml"
{%   else %}
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/secrets/kafka_server_jaas.conf"
{%   endif %}
{% elif jmx_enabled %}
      ########################################################
      # KAFKA_OPTS en mode non sécurisé (JMX seulement)
      ########################################################
      KAFKA_OPTS: "-javaagent:/opt/jmx/jmx_prometheus_javaagent.jar={{ jmx_agent_port_kafka }}:/etc/kafka/kafka_jmx.yml"
{% endif %}

    volumes:
      # server.properties de base (override par les env KAFKA_*)
      - "{{ compose_workdir }}/config/server.properties:/etc/kafka/server.properties:ro"

      # Data
      - "{{ kafka_data_dirs[0] }}:{{ kafka_data_dirs[0] }}"

{% if sasl_enabled %}
      # Keystore / Truststore + credentials
      - "{{ compose_workdir }}/config/keystore.jks:/etc/kafka/secrets/{{ keystore_filename }}:ro"
      - "{{ compose_workdir }}/config/truststore.jks:/etc/kafka/secrets/{{ truststore_filename }}:ro"
      - "{{ compose_workdir }}/config/keystore.creds:/etc/kafka/secrets/keystore.creds:ro"
      - "{{ compose_workdir }}/config/key.creds:/etc/kafka/secrets/key.creds:ro"
      - "{{ compose_workdir }}/config/truststore.creds:/etc/kafka/secrets/truststore.creds:ro"
      
      # Client Prop
      - "{{ compose_workdir }}/config/client.properties:/etc/kafka/secrets/client.properties:ro"
     
      # JAAS (si tu veux aussi l’utiliser côté file au lieu du inline JAAS)
      - "{{ compose_workdir }}/config/kafka_server_jaas.conf:/etc/kafka/secrets/kafka_server_jaas.conf:ro"
{% endif %}

{% if jmx_enabled %}
      # JMX Exporter
      - "{{ compose_workdir }}/jmx/jmx_prometheus_javaagent.jar:/opt/jmx/jmx_prometheus_javaagent.jar:ro"
      - "{{ compose_workdir }}/jmx/kafka.yml:/etc/kafka/kafka_jmx.yml:ro"
{% endif %}

